<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Room</title>
  <style>
    #chatdiv {
      width: 100vw;
      height: 100vh;

      background-image: url("https://www.popdaily.com.tw/shaper/wp-content/uploads/2021/06/6wpgbwnpqi8s0cc4kgks0wcs8qvfdwc-562x1000.jpg?resize-w=1300&resize-h=2301");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: top;
      text-align: center;
      z-index: 50;

    }

    ul {
      width: 98%;

      padding: 0;
      margin-top: 10px;

    }

    li {
      margin-top: 10px;
      padding: 10px;
      font-size: 20px;
      font-weight: bold;
      color: aqua;
      background-color: rgb(240, 148, 202);
      text-shadow: 10px -10px 2x rgb(0, 74, 124);
    }
  </style>
  <!-- 弹幕code------------------------------------------------------------------------->
  <title>Hello Page, Week1</title>
  <script type="text/javascript">
    window.addEventListener("load", init);

    function init() {

      resizeCanvas();


    }
  </script>
  <style>
    #title {
      text-align: center;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: #dcdedf;
    }

    .morph-section {
      width: 1000px;
      /* 增大宽度 */
      height: 1000px;
      /* 增大高度 */
      position: absolute;
      left: 50%;
      /* 左侧居中 */
      top: 50%;
      /* 垂直居中 */
      transform: translate(-70%, -26%);
      /* 调整居中 */
      font-family: monospace;
      color: #000000;
    }

    .info {
      font-family: monospace;
      position: absolute;
      line-height: 20px;
      font-size: 14px;
      left: 20px;
      bottom: 20px;
      color: #000000;
    }

    a {
      color: #000000;
    }

    #title {
      text-align: center;
      z-index: 1000;
      bottom: 45%;
      /* 距离底部的位置 */
      /* 文本输入框和按钮样式 */

    }

    #titleImage {
      display: none;
      /* 初始状态为隐藏 */
      width: 600px;
      /* 调整图片的宽度 */
      height: auto;
      /* 高度自动调整 */
      margin-left: 80px;
      /* 在图片和标题之间添加一些间距 */
      left: 40%;
      /* 左侧与标题的右侧对齐 */
      bottom: 55%;
      /* 距离底部的位置 */
    }

    #userInput,
    button {
      z-index: 1001;
      /* 高z-index值确保元素在最上面 */
      bottom: 45%;
      /* 距离底部的位置 */
      /* 添加更多样式以美化这些元素 */
    }

    /* 使文本输入框和按钮在页面中央下方显示 */
    #userInput {
      bottom: 30%;
      /* 距离底部的位置 */
      left: 40%;
      /* 水平居中 */
      justify-content: center;
      /* 垂直居中 */
      transform: translateX(0%);
      /* 调整位置以确保居中 */
      z-index: 1001;
    }

    button {
      bottom: 25%;
      /* 距离底部的位置 */
      left: 53%;
      /* 水平居中 */
      transform: translateX(8%);
      /* 调整位置以确保居中 */
      z-index: 1001;
    }

    #marqueeContainer {
      z-index: 1000;
    }

    #colorlabel {
      left: 30px;
    }

    #spongebobimg {
      position: absolute;
      left: 30vw;
      width: 500px;
      vertical-align: middle;

    }

    #underlayCanvas {
      width: 700px;

      background-image: url("https://i.pinimg.com/564x/a0/9d/82/a09d82b8cf4aff57d078ace5d63eb20d.jpg");
      background-size: cover;
    }
  </style>

</head>

<body>

  <form action="">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button type="submit">Send</button>
    <div id="messages"></div>
    <div id="marqueeContainer"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const form = document.querySelector('form');
      const input = document.querySelector('input');
      const ul = document.querySelector('ul');

      form.addEventListener('submit', e => {
        e.preventDefault();
        const message = input.value.trim();
        if (message) {
          socket.emit('chat message', message); // 发送聊天消息
          input.value = ''; // 清空输入框
        }
      });
      socket.on('chat message', msg => {
        var ul = document.getElementById('messageList'); // 假设你的<ul>元素有一个ID
        var li = document.createElement('li');
        li.textContent = msg;
        ul.appendChild(li);
      });
    </script>
  </form>

  <!-- 弹幕code------------------------------------------------------------------------->

  <h1 id="title">+HELLO WORLD+</h1>
  <p>

  </p>


  <pre>
        </pre>
  <script>
    function extend(target, source) {
      for (var key in source) {
        if (!(key in target)) {
          target[key] = source[key];
        }
      }
      return target;
    }

    function repeat(pattern, count) {
      if (count < 1) return '';
      var result = '';
      while (count > 1) {
        if (count & 1) result += pattern;
        count >>= 1, pattern += pattern;
      }
      return result + pattern;
    }

    function replaceAt(string, index, character) {
      return string.substr(0, index) + character + string.substr(index + character.length);
    }

    /**
     * AsciiMorph
     */

    function init(el, canvasSize) {

      // Save the element
      element = el;
      canvasDimensions = canvasSize;
    }

    function squareOutData(data) {
      var i;
      var renderDimensions = {
        x: 0,
        y: data.length
      };

      // Calculate centering numbers
      for (i = 0; i < data.length; i++) {
        if (data[i].length > renderDimensions.x) {
          renderDimensions.x = data[i].length
        }
      }

      // Pad out right side of data to square it out
      for (i = 0; i < data.length; i++) {
        if (data[i].length < renderDimensions.x) {
          data[i] = (data[i] + repeat(' ', renderDimensions.x - data[i].length));
        }
      }

      var paddings = {
        x: Math.floor((canvasDimensions.x - renderDimensions.x) / 2),
        y: Math.floor((canvasDimensions.y - renderDimensions.y) / 2)
      }

      // Left Padding
      for (var i = 0; i < data.length; i++) {
        data[i] = repeat(' ', paddings.x) + data[i] + repeat(' ', paddings.x);
      }

      // Pad out the rest of everything
      for (var i = 0; i < canvasDimensions.y; i++) {
        if (i < paddings.y) {
          data.unshift(repeat(' ', canvasDimensions.x));
        } else if (i > (paddings.y + renderDimensions.y)) {
          data.push(repeat(' ', canvasDimensions.x));
        }
      }

      return data;
    }

    // Crushes the frame data by 1 unit.
    function getMorphedFrame(data) {

      var firstInLine, lastInLine = null;
      var found = false;
      for (var i = 0; i < data.length; i++) {

        var line = data[i];
        firstInLine = line.search(/\S/);
        if (firstInLine === -1) {
          firstInLine = null;
        }

        for (var j = 0; j < line.length; j++) {
          if (line[j] != ' ') {
            lastInLine = j;
          }
        }

        if (firstInLine !== null && lastInLine !== null) {
          data = crushLine(data, i, firstInLine, lastInLine)
          found = true;
        }

        firstInLine = null, lastInLine = null;
      }

      if (found) {
        return data;
      } else {
        return false;
      }
    }

    function crushLine(data, line, start, end) {

      var centers = {
        x: Math.floor(canvasDimensions.x / 2),
        y: Math.floor(canvasDimensions.y / 2)
      }

      var crushDirection = 1;
      if (line > centers.y) {
        crushDirection = -1;
      }

      var charA = data[line][start];
      var charB = data[line][end];

      data[line] = replaceAt(data[line], start, " ");
      data[line] = replaceAt(data[line], end, " ");

      if (!((end - 1) == (start + 1)) && !(start === end) && !((start + 1) === end)) {
        data[line + crushDirection] = replaceAt(data[line + crushDirection], (start + 1), '+*/\\'.substr(Math
          .floor(Math.random() * '+*/\\'.length), 1));
        data[line + crushDirection] = replaceAt(data[line + crushDirection], (end - 1), '+*/\\'.substr(Math.floor(
          Math.random() * '+*/\\'.length), 1));
      } else if ((((start === end) || (start + 1) === end)) && ((line + 1) !== centers.y && (line - 1) !== centers
          .y && line !== centers.y)) {
        data[line + crushDirection] = replaceAt(data[line + crushDirection], (start), '+*/\\'.substr(Math.floor(
          Math.random() * '+*/\\'.length), 1));
        data[line + crushDirection] = replaceAt(data[line + crushDirection], (end), '+*/\\'.substr(Math.floor(Math
          .random() * '+*/\\'.length), 1));
      }

      return data;
    }

    function render(data) {
      var ourData = squareOutData(data.slice());
      renderSquareData(ourData);
    }

    function renderSquareData(data) {
      element.innerHTML = '';
      for (var i = 0; i < data.length; i++) {
        element.innerHTML = element.innerHTML + data[i] + '\n';
      }

      renderedData = data;
    }

    // Morph between whatever is current, to the new frame
    function morph(data) {

      clearTimeout(myTimeout);
      var frameData = prepareFrames(data.slice());
      animateFrames(frameData);
    }

    function prepareFrames(data) {

      var deconstructionFrames = [];
      var constructionFrames = [];

      var clonedData = renderedData

      // If its taking more than 100 frames, its probably somehow broken
      // Get the deconscrution frames
      for (var i = 0; i < 100; i++) {
        var newData = getMorphedFrame(clonedData);
        if (newData === false) {
          break;
        }
        deconstructionFrames.push(newData.slice(0));
        clonedData = newData;
      }

      // Get the constuction frames for the new data
      var squareData = squareOutData(data);
      constructionFrames.unshift(squareData.slice(0));
      for (var i = 0; i < 100; i++) {
        var newData = getMorphedFrame(squareData);
        if (newData === false) {
          break;
        }
        constructionFrames.unshift(newData.slice(0));
        squareData = newData;
      }

      return deconstructionFrames.concat(constructionFrames)
    }

    function animateFrames(frameData) {
      framesToAnimate = frameData;
      animateFrame();
    }

    function animateFrame() {
      myTimeout = setTimeout(function () {

        renderSquareData(framesToAnimate[0]);
        framesToAnimate.shift();
        if (framesToAnimate.length > 0) {
          animateFrame();
        }
      }, 20)

      // framesToAnimate
    }

    function main(element, canvasSize) {

      if (!element || !canvasSize) {
        console.log("sorry, I need an element and a canvas size");
        return;
      }

      init(element, canvasSize);
    }

    return extend(main, {
      render: render,
      morph: morph
    });


    var currentIndex = 2;


    function createMarquee() {
      var userInput = document.getElementById('messageInput').value;
      var marqueeContainer = document.getElementById('marqueeContainer');

      // 创建 marquee 元素
      var marquee = document.createElement('marquee');
      marquee.textContent = userInput;

      // 可以在这里添加更多的 marquee 属性，比如滚动速度、方向等
      marquee.style.position = 'absolute';
      marquee.style.top = Math.random() * window.innerHeight + 'px';
      marquee.style.left = Math.random() * window.innerWidth + 'px';

      // 将 marquee 元素添加到页面中
      marqueeContainer.appendChild(marquee);
    }

    function createMarquee_para(messageInput) {
      var userInput = messageInput;
      var marqueeContainer = document.getElementById('marqueeContainer');

      // 创建 marquee 元素
      var marquee = document.createElement('marquee');
      marquee.textContent = userInput;

      // 可以在这里添加更多的 marquee 属性，比如滚动速度、方向等
      marquee.style.position = 'absolute';
      marquee.style.top = Math.random() * window.innerHeight + 'px';
      marquee.style.left = Math.random() * window.innerWidth + 'px';

      // 将 marquee 元素添加到页面中
      marqueeContainer.appendChild(marquee);
    }
  </script>
  <div id="chatdiv">
    <ul id="messageList"></ul>
    <span id="spongebobspan" style="text-align: center;">
    </span>
    <span>
      <canvas id="mycanvas"></canvas>
      
    </span>
    <span>
      <canvas id="underlayCanvas"></canvas>
    </span>

    <label for="colorpick" id="colorlabel">"Choose your brush color"</label>
    <input type="color" id="colorpick" name="color">


    <video src="" id="thevideo"></video>
    <canvas id = "thecanvas"></canvas>
    <img src="" alt="" id = "theimg">
  </div>
  <div>

  </div>
  
  <script>
    window.addEventListener('onload', function () {
      let video = document.getElementById('thevideo');
      let thecanvas = document.getElementById('thecanvas');
      let constraints = {
        video: true,
        audio: true
      };

      navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
          /* Use the stream */

          // Attach to our video object
          video.srcObject = stream;

          // Wait for the stream to load enough to play
          video.onloadedmetadata = function (e) {
            video.play();
            setInterval(function () {
              thecanvas.width = video.videoWidth;
              thecanvas.height = video.videoHeight;
              thecanvas.getContext('2d').drawImage(video, 0, 0, thecanvas.width, thecanvas.height);
            }, 1000);
              socket.emit('video', thecanvas.toDataURL());
          };
        })
        socket.on('v', function (data) {
          let theimg = document.getElementById('theimg');
          theimg.src = data;
        })
        .catch(function (err) {
          /* Handle the error */
          alert(err);
        });
    });
  </script>
  <script>
    const underlayCanvas = document.getElementById('underlayCanvas');

    const underCtx = underlayCanvas.getContext('2d');

    underCtx.fillStyle = 'lightblue'; // 仅示例，实际可以用drawImage等方法
    underCtx.fillRect(0, 0, underlayCanvas.width, underlayCanvas.height);

    let upainting = false;
    let ustartPoint = {
      x: undefined,
      y: undefined
    };
    underlayCanvas.addEventListener('mousedown', (e) => {
      upainting = true;
      ustartPoint = {
        x: e.offsetX,
        y: e.offsetY
      };
    });
    underlayCanvas.addEventListener('mousemove', (e) => {
      if (!upainting) return;
      const unewPoint = {
        x: e.offsetX,
        y: e.offsetY
      };
      eraseLine(ustartPoint.x, ustartPoint.y, unewPoint.x, unewPoint.y);
      ustartPoint = unewPoint;
      socket.emit('erasing', {
        xuStart: ustartPoint.x,
        yuStart: ustartPoint.y,
        xuEnd: unewPoint.x,
        yuEnd: unewPoint.y
      });
    });
    underlayCanvas.addEventListener('mouseup', () => {
      upainting = false;
    });
    socket.on('erase', (data) => {
      eraseLine(data.xuStart, data.yuStart, data.xuEnd, data.yuEnd);
    });

    function eraseLine(xStart, yStart, xEnd, yEnd) {
      underCtx.globalCompositeOperation = 'destination-out';
      underCtx.beginPath();
      underCtx.lineWidth = 5;
      underCtx.strokeStyle = 'lightblue';
      underCtx.moveTo(xStart, yStart);
      underCtx.lineTo(xEnd, yEnd);
      underCtx.stroke();
      underCtx.closePath();
    };
    let painting = false;
    let startPoint = {
      x: undefined,
      y: undefined
    };
    const canvas = document.getElementById('mycanvas');
    const ctx = canvas.getContext('2d');

    canvas.addEventListener('mousedown', (e) => {
      painting = true;
      startPoint = {
        x: e.offsetX,
        y: e.offsetY
      };
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!painting) return;
      const newPoint = {
        x: e.offsetX,
        y: e.offsetY
      };
      drawLine(startPoint.x, startPoint.y, newPoint.x, newPoint.y);
      socket.emit('drawing', {
        xStart: startPoint.x,
        yStart: startPoint.y,
        xEnd: newPoint.x,
        yEnd: newPoint.y
      });
      startPoint = newPoint;
    });

    canvas.addEventListener('mouseup', () => {
      painting = false;
    });

    socket.on('draw', (data) => {
      drawLine(data.xStart, data.yStart, data.xEnd, data.yEnd);
    });

    function drawLine(xStart, yStart, xEnd, yEnd) {
      ctx.beginPath();
      ctx.lineWidth = 5;
      ctx.strokeStyle = brushColor;
      ctx.moveTo(xStart, yStart);
      ctx.lineTo(xEnd, yEnd);
      ctx.stroke();
      ctx.closePath();
    };

    function resizeCanvas() {
      var container = document.getElementById('chatdiv');
      var canvas = document.getElementById('mycanvas');

      // 设置canvas尺寸等于容器的尺寸
      canvas.width = container.offsetWidth;
      canvas.height = container.offsetHeight;
    }

    // 当文档加载完成时调整canvas大小

    // 如果你想要在窗口大小改变时也调整canvas，可以监听resize事件
    const colorPicker = document.getElementById("colorpick");
    let brushColor = "#000"
    window.addEventListener('resize', resizeCanvas);

    function changeColor(e) {
      brushColor = e.target.value;
      socket.emit('Bcolor', brushColor);
    }
    socket.on('Bcolorchange', (color) => {
      brushColor = color;
    });

    colorPicker.addEventListener("change", changeColor);
  </script>
</body>

</html>